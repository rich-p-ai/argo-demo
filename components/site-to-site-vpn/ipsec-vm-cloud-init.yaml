---
# Cloud-init configuration for IPSec VMs
# This Secret contains the cloud-init user-data for VM initialization
apiVersion: v1
kind: Secret
metadata:
  name: ipsec-vm-cloudinit
  namespace: vpn-infra
  annotations:
    description: "Cloud-init configuration for IPSec gateway VMs"
type: Opaque
stringData:
  userdata: |
    #cloud-config
    # Cloud-init configuration for CentOS/RHEL IPSec VMs
    
    # CHANGE THIS PASSWORD
    password: changethis
    chpasswd:
      expire: false
    
    # Add your SSH public keys here
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQD... your-key-here
    
    # Install required packages
    packages:
      - libreswan
      - keepalived
      - tcpdump
      - net-tools
      - bind-utils
    
    # System configuration
    bootcmd:
      - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.d/99-ipsec.conf
      - echo "net.ipv4.conf.all.rp_filter=0" >> /etc/sysctl.d/99-ipsec.conf
      - echo "net.ipv4.conf.default.rp_filter=0" >> /etc/sysctl.d/99-ipsec.conf
      - echo "net.ipv4.conf.all.accept_redirects=0" >> /etc/sysctl.d/99-ipsec.conf
      - echo "net.ipv4.conf.default.accept_redirects=0" >> /etc/sysctl.d/99-ipsec.conf
      - echo "net.ipv4.conf.all.send_redirects=0" >> /etc/sysctl.d/99-ipsec.conf
      - echo "net.ipv4.conf.default.send_redirects=0" >> /etc/sysctl.d/99-ipsec.conf
      - sysctl --system
    
    runcmd:
      - systemctl enable libreswan
      - systemctl enable keepalived
      # Firewalld configuration - allow IPSec traffic
      - firewall-cmd --permanent --add-service=ipsec
      - firewall-cmd --permanent --add-port=500/udp
      - firewall-cmd --permanent --add-port=4500/udp
      - firewall-cmd --reload
    
    final_message: "IPSec VM initialization complete. Configure network interface and certificates manually."
