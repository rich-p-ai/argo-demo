---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ipsec-config
  namespace: site-to-site-vpn
data:
  # strongSwan ipsec.conf for AWS Site-to-Site VPN (non-prod)
  # VPN Connection: vpn-059ee0661e851adf4
  # Customer Gateway: cgw-0f82cc789449111b7
  # Ref: certs/non-prod/vpn-059ee0661e851adf49 1.txt
  ipsec.conf: |
    config setup
        charondebug="ike 2, knl 2, cfg 2, net 2, esp 2, dmn 2, mgr 2"
        uniqueids=no

    conn %default
        keyexchange=ikev1
        # Match AWS: AES128, SHA1, DH group2 (doc minimum)
        ike=aes128-sha1-modp1024!
        esp=aes128-sha1-modp1024!
        ikelifetime=28800s
        lifetime=3600s
        dpdaction=restart
        dpddelay=10s
        dpdtimeout=30s
        rekey=yes
        reauth=no
        # Certificate-based authentication
        authby=rsasig
        leftcert=client-cert.pem
        left=%defaultroute
        leftsubnet=0.0.0.0/0
        # Canon corporate networks - allows VPN access from all Canon offices
        # Includes: 10.63.0.0/16, 10.68.0.0/16, 10.99.0.0/16, 10.110.0.0/16,
        #           10.140.0.0/16, 10.141.0.0/16 (NY office), 10.158.0.0/16,
        #           10.227.112.0/20 (original on-prem)
        rightsubnet=10.63.0.0/16,10.68.0.0/16,10.99.0.0/16,10.110.0.0/16,10.140.0.0/16,10.141.0.0/16,10.158.0.0/16,10.227.112.0/20
        auto=start
        closeaction=restart
        type=tunnel
        installpolicy=yes
        aggressive=no

    # AWS VPN Tunnel 1 (Primary) - 3.232.27.186
    conn aws-vpn-tunnel1
        right=3.232.27.186
        rightid="CN=vpn-059ee0661e851adf4.endpoint-0"
        leftid="vpn-059ee0661e851adf4.endpoint-0"
        leftsourceip=169.254.43.134
        mark=100
        # Prioritize tunnel 1 as primary
        reqid=1

    # AWS VPN Tunnel 2 (Secondary) - 98.94.136.2
    conn aws-vpn-tunnel2
        right=98.94.136.2
        rightid="CN=vpn-059ee0661e851adf4.endpoint-1"
        leftid="vpn-059ee0661e851adf4.endpoint-0"
        leftsourceip=169.254.118.14
        mark=200
        # Configure tunnel 2 with different reqid for parallel operation
        reqid=2

  # IPSec secrets - private key (decrypted)
  ipsec.secrets: |
    # Private key for certificate authentication (no passphrase needed)
    : RSA client-key.pem

  # Startup script: install strongSwan from EPEL on UBI9 then start
  start-vpn.sh: |
    #!/bin/bash
    set -e
    export PATH=$PATH:/usr/sbin:/sbin:/usr/bin:/bin:/usr/libexec/ipsec

    echo "Starting Site-to-Site VPN Client..."
    echo "================================================"

    # Install strongSwan from EPEL on UBI9 (no strongSwan in RH default repos)
    echo "Installing strongSwan from EPEL..."
    dnf install -y --nodocs https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm 2>&1 | tail -3 || true
    dnf install -y --nodocs strongswan procps-ng 2>&1 | tail -5 || true

    # Find starter binary (reads ipsec.conf and manages charon)
    STARTER_BIN=$(find /usr -name starter -type f 2>/dev/null | head -1)
    if [ -n "$STARTER_BIN" ]; then
      echo "Found starter at: $STARTER_BIN"
    else
      echo "ERROR: starter binary not found after install."
      echo "Installed strongSwan files:"
      rpm -ql strongswan 2>&1 | head -30
      exit 1
    fi

    # Enable IP forwarding
    echo "Configuring kernel parameters..."
    /usr/sbin/sysctl -w net.ipv4.ip_forward=1 2>&1 || true
    /usr/sbin/sysctl -w net.ipv4.conf.all.accept_redirects=0 2>&1 || true
    /usr/sbin/sysctl -w net.ipv4.conf.all.send_redirects=0 2>&1 || true
    /usr/sbin/sysctl -w net.ipv4.conf.default.rp_filter=0 2>&1 || true
    /usr/sbin/sysctl -w net.ipv4.conf.all.rp_filter=0 2>&1 || true

    # Add route to windows-non-prod CUDN (10.227.128.0/21) via gateway VM
    echo "Adding route to windows-non-prod CUDN..."
    GATEWAY_VM_IP="10.135.0.25"  # Updated: cudn-gateway pod network IP
    ip route add 10.227.128.0/21 via $GATEWAY_VM_IP dev eth0 2>/dev/null || true
    if ip route show | grep -q "10.227.128.0/21"; then
        echo "✓ Route added: 10.227.128.0/21 via $GATEWAY_VM_IP"
    else
        echo "⚠ Could not add route (may already exist or gateway VM not ready)"
    fi

    # Ensure directories exist
    mkdir -p /etc/strongswan/ipsec.d/private
    mkdir -p /etc/strongswan/ipsec.d/certs
    mkdir -p /etc/strongswan/ipsec.d/cacerts

    # Copy configuration files
    echo "Copying IPSec configuration..."
    cp /etc/ipsec-config/ipsec.conf /etc/strongswan/ipsec.conf
    cp /etc/ipsec-config/ipsec.secrets /etc/strongswan/ipsec.secrets

    # Copy certificates if mounted
    if [ -f /etc/vpn-certs/client-cert.pem ]; then
        echo "Loading VPN certificates..."
        cp /etc/vpn-certs/client-cert.pem /etc/strongswan/ipsec.d/certs/
        cp /etc/vpn-certs/client-key.pem /etc/strongswan/ipsec.d/private/
        cp /etc/vpn-certs/ca-chain.pem /etc/strongswan/ipsec.d/cacerts/
        chmod 600 /etc/strongswan/ipsec.d/private/client-key.pem
        chmod 644 /etc/strongswan/ipsec.d/certs/client-cert.pem
        chmod 644 /etc/strongswan/ipsec.d/cacerts/ca-chain.pem
        echo "✓ Certificates loaded"
    else
        echo "ERROR: VPN certificates not found!"
        echo "Create the 'vpn-certificates' secret with client-cert.pem, client-key.pem, ca-chain.pem"
        exit 1
    fi

    # Start strongSwan with starter (reads ipsec.conf)
    echo "Starting strongSwan with starter (ipsec.conf mode)..."
    echo "================================================"
    exec $STARTER_BIN --nofork
