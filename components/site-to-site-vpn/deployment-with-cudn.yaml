---
# Site-to-Site VPN Deployment with CUDN Attachment
# The VPN pod acts as gateway (10.227.128.1) for windows-non-prod network
apiVersion: apps/v1
kind: Deployment
metadata:
  name: site-to-site-vpn
  namespace: site-to-site-vpn
  labels:
    app: site-to-site-vpn
    app.kubernetes.io/name: site-to-site-vpn
    app.kubernetes.io/component: vpn-client
  annotations:
    description: "Site-to-Site VPN with windows-non-prod CUDN gateway"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: site-to-site-vpn
  template:
    metadata:
      labels:
        app: site-to-site-vpn
        app.kubernetes.io/name: site-to-site-vpn
        app.kubernetes.io/component: vpn-client
      annotations:
        # Attach to windows-non-prod CUDN with static IP 10.227.128.1
        k8s.v1.cni.cncf.io/networks: |
          [
            {
              "name": "windows-non-prod",
              "namespace": "site-to-site-vpn"
            }
          ]
    spec:
      serviceAccountName: site-to-site-vpn
      # NOTE: hostNetwork removed - incompatible with Multus
      dnsPolicy: ClusterFirst
      nodeSelector:
        node-role.kubernetes.io/worker: ""
      tolerations:
        - key: "node.kubernetes.io/unschedulable"
          operator: "Exists"
          effect: "NoSchedule"
      initContainers:
        # Configure gateway IP and routing for CUDN
        - name: setup-cudn-gateway
          image: registry.access.redhat.com/ubi9/ubi:latest
          command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e
              
              echo "=========================================="
              echo "Configuring VPN as CUDN Gateway"
              echo "=========================================="
              
              # Install required packages
              echo "Installing sysctl and iptables..."
              dnf install -y procps-ng iptables 2>&1 | tail -5
              
              # Enable IP forwarding
              echo "Enabling IP forwarding..."
              /usr/sbin/sysctl -w net.ipv4.ip_forward=1
              /usr/sbin/sysctl -w net.ipv4.conf.all.rp_filter=0
              /usr/sbin/sysctl -w net.ipv4.conf.default.rp_filter=0
              /usr/sbin/sysctl -w net.ipv4.conf.all.accept_redirects=0
              /usr/sbin/sysctl -w net.ipv4.conf.all.send_redirects=0
              
              # Wait for interfaces
              echo "Waiting for network interfaces..."
              for i in {1..30}; do
                if ip link show net1 &>/dev/null; then
                  echo "✓ net1 interface found"
                  break
                fi
                sleep 1
              done
              
              # Configure static IP 10.227.128.1 on net1 (CUDN interface)
              echo "Configuring CUDN gateway IP..."
              
              # Check if IP was auto-assigned
              CURRENT_IP=$(ip -4 addr show net1 | grep inet | awk '{print $2}' | head -1)
              if [ -n "$CURRENT_IP" ]; then
                echo "Current IP on net1: $CURRENT_IP"
                # Remove auto-assigned IP if it's not 10.227.128.1
                if [ "$CURRENT_IP" != "10.227.128.1/21" ]; then
                  echo "Removing auto-assigned IP..."
                  ip addr flush dev net1
                fi
              fi
              
              # Add gateway IP
              if ! ip addr show net1 | grep -q "10.227.128.1/21"; then
                echo "Adding gateway IP 10.227.128.1/21..."
                ip addr add 10.227.128.1/21 dev net1
              fi
              
              # Ensure interface is up
              ip link set net1 up
              
              echo "✓ Gateway IP configured"
              
              # Configure iptables for NAT and forwarding
              echo "Configuring NAT and forwarding..."
              
              # NAT for CUDN traffic going to external networks
              iptables -t nat -A POSTROUTING -s 10.227.128.0/21 ! -d 10.227.128.0/21 -j MASQUERADE
              
              # Allow forwarding between CUDN and pod network
              iptables -A FORWARD -i net1 -o eth0 -j ACCEPT
              iptables -A FORWARD -i eth0 -o net1 -m state --state RELATED,ESTABLISHED -j ACCEPT
              
              # Allow forwarding within CUDN (VM-to-VM)
              iptables -A FORWARD -i net1 -o net1 -j ACCEPT
              
              echo "✓ Forwarding configured"
              echo ""
              echo "=========================================="
              echo "Gateway Configuration Complete"
              echo "=========================================="
              echo "Interfaces:"
              ip -br addr show
              echo ""
              echo "Routing table:"
              ip route show
              echo ""
              echo "NAT rules:"
              iptables -t nat -L POSTROUTING -n -v | head -10
              echo "=========================================="
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN
      containers:
        - name: strongswan
          image: registry.access.redhat.com/ubi9/ubi:latest
          command: ["/bin/bash", "/etc/ipsec-config/start-vpn.sh"]
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN
                - NET_RAW
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: ipsec-config
              mountPath: /etc/ipsec-config
              readOnly: true
            - name: vpn-certs
              mountPath: /etc/vpn-certs
              readOnly: true
            - name: run
              mountPath: /run
            - name: var-run
              mountPath: /var/run
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "ps aux | grep -q '[c]haron' && ip addr show net1 | grep -q 10.227.128.1"
            initialDelaySeconds: 180
            periodSeconds: 60
            failureThreshold: 5
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "ps aux | grep -q '[c]haron' && ip addr show net1 | grep -q 10.227.128.1"
            initialDelaySeconds: 120
            periodSeconds: 30
      volumes:
        - name: ipsec-config
          configMap:
            name: ipsec-config
            defaultMode: 0755
        - name: vpn-certs
          secret:
            secretName: vpn-certificates
            defaultMode: 0600
        - name: run
          emptyDir: {}
        - name: var-run
          emptyDir: {}
