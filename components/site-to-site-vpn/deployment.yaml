---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: site-to-site-vpn
  namespace: site-to-site-vpn
  labels:
    app: site-to-site-vpn
    app.kubernetes.io/name: site-to-site-vpn
    app.kubernetes.io/component: vpn-client
  annotations:
    description: "Site-to-Site VPN client connecting to AWS Transit Gateway"
spec:
  replicas: 0
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: site-to-site-vpn
  template:
    metadata:
      labels:
        app: site-to-site-vpn
        app.kubernetes.io/name: site-to-site-vpn
        app.kubernetes.io/component: vpn-client
    spec:
      serviceAccountName: site-to-site-vpn
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        node-role.kubernetes.io/worker: ""
      tolerations:
        - key: "node.kubernetes.io/unschedulable"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
        - name: strongswan
          # UBI9: strongSwan installed at startup from EPEL (Red Hat registry only)
          image: registry.access.redhat.com/ubi9/ubi:latest
          command: ["/bin/bash", "/etc/ipsec-config/start-vpn.sh"]
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN
                - NET_RAW
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: ipsec-config
              mountPath: /etc/ipsec-config
              readOnly: true
            - name: vpn-certs
              mountPath: /etc/vpn-certs
              readOnly: true
            - name: run
              mountPath: /run
            - name: var-run
              mountPath: /var/run
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "ps aux | grep -q '[c]haron'"
            initialDelaySeconds: 180
            periodSeconds: 60
            failureThreshold: 5
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "ps aux | grep -q '[c]haron'"
            initialDelaySeconds: 120
            periodSeconds: 30
      volumes:
        - name: ipsec-config
          configMap:
            name: ipsec-config
            defaultMode: 0755
        - name: vpn-certs
          secret:
            secretName: vpn-certificates
            defaultMode: 0600
        - name: run
          emptyDir: {}
        - name: var-run
          emptyDir: {}
